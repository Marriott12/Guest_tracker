{% extends "admin/base_site.html" %}
{% load static %}
{% block content %}
<h1>Active Check-in Sessions</h1>
<form method="post">{% csrf_token %}
<table class="adminlist">
  <thead><tr><th>Event</th><th>Date</th><th>Active Session (cache)</th><th>Recent Sessions (DB)</th><th>Action</th></tr></thead>
  <tbody>
  {% for item in sessions %}
    <tr>
      <td>{{ item.event.name }}</td>
      <td>{{ item.event.date }}</td>
      <td>
        {% if item.session %}
          Started by: {{ item.session.started_by }} at {{ item.session.started_at }}
        {% else %}
          -
        {% endif %}
      </td>
      <td>
        {% if item.recent_db and item.recent_db|length > 0 %}
          <ul style="margin:0;padding-left:1em;">
          {% for s in item.recent_db %}
            <li>
              {% if s.started_by %}{{ s.started_by.username }}{% else %}unknown{% endif %} {{ s.started_at|date:"Y-m-d H:i" }}
              {% if s.ended_at %} â€” Ended by: {% if s.ended_by %}{{ s.ended_by.username }}{% else %}unknown{% endif %} {{ s.ended_at|date:"Y-m-d H:i" }}{% endif %}
            </li>
          {% endfor %}
          </ul>
          <a href="{% url 'admin:guests_checkinsession_changelist' %}?event__id__exact={{ item.event.id }}">View all</a>
        {% else %}
          -
        {% endif %}
      </td>
      <td>
        {% if item.session %}
          <button type="button" class="button session-action" data-action="end" data-eventid="{{ item.event.id }}">End Session</button>
          <a href="{% url 'scan_barcode' %}?event_id={{ item.event.id }}" class="button" target="_blank" style="margin-left: 8px; background: #28a745; color: white;">
            <i class="fas fa-barcode"></i> Scan Guests
          </a>
        {% else %}
          <button type="button" class="button session-action" data-action="start" data-eventid="{{ item.event.id }}">Start Session</button>
        {% endif %}
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
<input type="hidden" id="evid" name="event_id" value="" />
</form>
<!-- Lightweight modal for confirming session start/end -->
<div id="session-confirm-modal" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.4);z-index:2000;">
  <div style="position:relative;max-width:520px;margin:80px auto;background:#fff;padding:20px;border-radius:6px;">
    <h2 id="modal-title">Confirm</h2>
    <p id="modal-message">Are you sure?</p>
    <div style="text-align:right;margin-top:16px;">
      <button type="button" id="modal-cancel" class="button">Cancel</button>
      <button type="button" id="modal-confirm" class="button button-primary">Confirm</button>
    </div>
  </div>
</div>
<script>
  (function(){
    var modal = document.getElementById('session-confirm-modal');
    var msg = document.getElementById('modal-message');
    var title = document.getElementById('modal-title');
    var btnConfirm = document.getElementById('modal-confirm');
    var btnCancel = document.getElementById('modal-cancel');
    var pending = {action: null, eventId: null};

    function showModal(action, eventId){
      pending.action = action; pending.eventId = eventId;
      title.textContent = action === 'start' ? 'Start Check-in Session' : 'End Check-in Session';
      msg.textContent = action === 'start'
        ? 'Start check-in session for this event? This will create a persistent session record.'
        : 'End the active check-in session for this event? This will mark the session ended in the audit log.';
      modal.style.display = 'block';
    }

    function hideModal(){
      modal.style.display = 'none';
      pending.action = null; pending.eventId = null;
    }

    document.querySelectorAll('.session-action').forEach(function(btn){
      btn.addEventListener('click', function(e){
        var action = btn.getAttribute('data-action');
        var eid = btn.getAttribute('data-eventid');
        showModal(action, eid);
      });
    });

    btnCancel.addEventListener('click', function(){ hideModal(); });

    btnConfirm.addEventListener('click', function(){
      if(!pending.action || !pending.eventId){ hideModal(); return; }
      // submit the outer form with action and event_id
      var form = document.querySelector('form');
      if(!form){ hideModal(); return; }
      // set hidden event id
      document.getElementById('evid').value = pending.eventId;
      // create or update hidden action input
      var existing = form.querySelector('input[name="action"]');
      if(existing){ existing.value = pending.action; }
      else{
        var inp = document.createElement('input'); inp.type='hidden'; inp.name='action'; inp.value=pending.action; form.appendChild(inp);
      }
      form.submit();
    });
  })();
</script>
{% endblock %}
