{% extends 'guests/base.html' %}

{% block title %}Scan Barcode - Zambia Army Guest Tracking System{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Mode Switcher -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Scanning Mode</h5>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="multiScanMode" style="width: 3em; height: 1.5em;">
                            <label class="form-check-label ms-2" for="multiScanMode">
                                <strong>Multi-Scan Mode</strong> <small class="text-muted">(Rapid Check-ins)</small>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Multi-Scan Queue (Hidden by default) -->
            <div id="scanQueue" class="card mb-3" style="display: none;">
                <div class="card-header bg-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-users me-2"></i>Check-In Queue (<span id="queueCount">0</span>)
                        </h5>
                        <button id="clearQueueBtn" class="btn btn-light btn-sm">
                            <i class="fas fa-trash me-1"></i>Clear All
                        </button>
                    </div>
                </div>
                <div class="card-body" id="queueList" style="max-height: 300px; overflow-y: auto;">
                    <!-- Queue items will be inserted here -->
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-barcode me-2"></i>Scan Guest Barcode
                    </h4>
                </div>
                <div class="card-body">
                    <form method="post" id="scanForm">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="barcode_number" class="form-label">Enter Barcode Number:</label>
                            <input type="text" 
                                   class="form-control form-control-lg" 
                                   id="barcode_number" 
                                   name="barcode_number" 
                                   placeholder="Scan or type barcode number" 
                                   autofocus
                                   required>
                            <div class="form-text">Use a barcode scanner or manually enter the barcode number</div>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <label for="table_number" class="form-label">Table Number (optional)</label>
                                <input type="text" id="table_number" name="table_number" class="form-control" placeholder="e.g. 12" />
                            </div>
                            <div class="col-md-6">
                                <label for="seat_number" class="form-label">Seat Number (optional)</label>
                                <input type="text" id="seat_number" name="seat_number" class="form-control" placeholder="e.g. A" />
                            </div>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="button" id="searchBtn" class="btn btn-primary btn-lg w-100">
                                <i class="fas fa-search me-2"></i>Search Guest
                            </button>
                            <button type="button" id="checkInBtn" class="btn btn-success btn-lg w-100">
                                <i class="fas fa-check me-2"></i>Check In Guest
                            </button>
                        </div>
                    </form>

                    <div class="mt-4">
                        <h5>Camera Scanner (QR)</h5>
                        <p class="text-muted">Use your device camera to scan QR codes. This complements keyboard barcode scanners.</p>
                        <div id="cameraControls" class="mb-2">
                            <button type="button" id="startCameraBtn" class="btn btn-outline-primary btn-sm">Start Camera</button>
                            <button type="button" id="stopCameraBtn" class="btn btn-outline-secondary btn-sm" disabled>Stop Camera</button>
                        </div>
                        <div id="cameraArea" style="display:none;">
                            <video id="video" autoplay muted playsinline style="width:100%;max-height:360px;border:1px solid #ddd;border-radius:6px;background:#000"></video>
                            <canvas id="videoCanvas" style="display:none;"></canvas>
                            <div id="cameraHint" class="form-text">Point the camera at a QR code. When detected, the invitation will be looked up.</div>
                        </div>
                    </div>

                    <div id="scanResult" class="mt-4" style="display:none"></div>
                </div>
            </div>

            <div class="mt-3 text-center">
                <a href="{% url 'organizer_dashboard' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    // ============================================
    // Audio Feedback System
    // ============================================
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    
    function playBeep(frequency = 800, duration = 100, type = 'success') {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        if (type === 'success') {
            oscillator.frequency.value = 800; // High pitch for success
        } else if (type === 'error') {
            oscillator.frequency.value = 200; // Low pitch for error
        } else {
            oscillator.frequency.value = frequency;
        }
        
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration / 1000);
    }
    
    function playSuccessBeep() {
        // Two-tone success beep
        playBeep(800, 100);
        setTimeout(() => playBeep(1000, 100), 120);
    }
    
    function playErrorBeep() {
        playBeep(200, 200, 'error');
    }

    // ============================================
    // Multi-Scan Mode Management
    // ============================================
    let multiScanMode = false;
    let scanQueue = [];
    
    const multiScanToggle = document.getElementById('multiScanMode');
    const queueContainer = document.getElementById('scanQueue');
    const queueList = document.getElementById('queueList');
    const queueCount = document.getElementById('queueCount');
    const clearQueueBtn = document.getElementById('clearQueueBtn');
    
    multiScanToggle.addEventListener('change', function() {
        multiScanMode = this.checked;
        queueContainer.style.display = multiScanMode ? 'block' : 'none';
        if (!multiScanMode) {
            scanQueue = [];
            updateQueueDisplay();
        }
    });
    
    clearQueueBtn.addEventListener('click', function() {
        if (confirm('Clear all queued check-ins?')) {
            scanQueue = [];
            updateQueueDisplay();
        }
    });
    
    function addToQueue(invitation, checked_in) {
        const exists = scanQueue.find(item => item.barcode_number === invitation.barcode_number);
        if (exists) {
            playErrorBeep();
            return;
        }
        
        scanQueue.push({
            ...invitation,
            timestamp: new Date(),
            checked_in: checked_in
        });
        
        updateQueueDisplay();
        playSuccessBeep();
    }
    
    function removeFromQueue(barcode) {
        scanQueue = scanQueue.filter(item => item.barcode_number !== barcode);
        updateQueueDisplay();
    }
    
    function updateQueueDisplay() {
        queueCount.textContent = scanQueue.length;
        
        if (scanQueue.length === 0) {
            queueList.innerHTML = '<p class="text-muted text-center mb-0">No guests in queue</p>';
            return;
        }
        
        queueList.innerHTML = scanQueue.map((item, index) => {
            const displayName = (item.guest_rank ? (item.guest_rank + ' ') : '') + item.guest_name;
            const badgeClass = item.checked_in ? 'bg-success' : 'bg-warning';
            const statusText = item.checked_in ? 'Checked In' : 'Pending';
            
            return `
                <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                    <div>
                        <strong>${index + 1}. ${displayName}</strong>
                        <small class="d-block text-muted">${item.event}</small>
                        <span class="badge ${badgeClass}">${statusText}</span>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeFromQueue('${item.barcode_number}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        }).join('');
    }
    
    // Make removeFromQueue globally accessible
    window.removeFromQueue = removeFromQueue;

    // ============================================
    // Auto-submit form when barcode is scanned
    // ============================================
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    async function postJson(url, data) {
        const resp = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify(data)
        });
        return resp.json();
    }

    document.getElementById('barcode_number').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            if (multiScanMode) {
                // In multi-scan mode, auto check-in
                document.getElementById('checkInBtn').click();
            } else {
                // In single mode, just search
                document.getElementById('searchBtn').click();
            }
        }
    });

    document.getElementById('searchBtn').addEventListener('click', async function() {
        const barcode = document.getElementById('barcode_number').value.trim();
        if (!barcode) return;
        const result = await postJson('{% url "api_check_in" %}', { barcode_number: barcode, check_in: false, table_number: document.getElementById('table_number').value.trim(), seat_number: document.getElementById('seat_number').value.trim() });
        renderResult(result, false);
    });

    document.getElementById('checkInBtn').addEventListener('click', async function() {
        const barcode = document.getElementById('barcode_number').value.trim();
        if (!barcode) return;
        const result = await postJson('{% url "api_check_in" %}', { barcode_number: barcode, check_in: true, table_number: document.getElementById('table_number').value.trim(), seat_number: document.getElementById('seat_number').value.trim() });
        renderResult(result, true);
    });

    function renderResult(result, wasCheckIn) {
        const container = document.getElementById('scanResult');
        container.style.display = 'block';
        
        if (!result) {
            container.innerHTML = '<div class="alert alert-danger">No response from server</div>';
            playErrorBeep();
            return;
        }
        if (result.status === 'forbidden') {
            container.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
            playErrorBeep();
            return;
        }
        if (result.status === 'not_found' || result.status === 'error') {
            container.innerHTML = `<div class="alert alert-warning">${result.message}</div>`;
            playErrorBeep();
            return;
        }
        if (result.status === 'ok') {
            const inv = result.invitation;
            
            // Play success sound
            playSuccessBeep();
            
            // Add to queue if in multi-scan mode
            if (multiScanMode && wasCheckIn) {
                addToQueue(inv, inv.checked_in);
                // Auto-clear input for next scan
                document.getElementById('barcode_number').value = '';
                document.getElementById('barcode_number').focus();
                // Show minimal feedback in single scan result area
                container.innerHTML = `
                    <div class="alert alert-success alert-dismissible fade show">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>${(inv.guest_rank ? (inv.guest_rank + ' ') : '') + inv.guest_name}</strong> added to queue!
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                // Auto-hide after 2 seconds
                setTimeout(() => {
                    container.style.display = 'none';
                }, 2000);
                return;
            }
            
            // Regular single-scan display
            const displayName = (inv.guest_rank ? (inv.guest_rank + ' ') : '') + inv.guest_name;
            container.innerHTML = `
                <div class="p-3 bg-light rounded">
                    <h5 class="mb-2">${displayName}</h5>
                    ${inv.guest_institution ? `<p><strong>Institution:</strong> ${inv.guest_institution}</p>` : ''}
                    <p><strong>Email:</strong> ${inv.email}</p>
                    <p><strong>Event:</strong> ${inv.event}</p>
                    <p><strong>Checked In:</strong> ${inv.checked_in ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-warning">No</span>'}</p>
                        <p><strong>Table:</strong> ${inv.table_number || 'Unassigned'} &nbsp; <strong>Seat:</strong> ${inv.seat_number || 'Unassigned'}</p>
                        <div class="row g-2 mt-2">
                            <div class="col-md-6">
                                <input id="result_table_number" class="form-control" placeholder="Table (optional)" value="${inv.table_number || ''}" />
                            </div>
                            <div class="col-md-6">
                                <input id="result_seat_number" class="form-control" placeholder="Seat (optional)" value="${inv.seat_number || ''}" />
                            </div>
                        </div>
                        <div class="mt-2">
                            ${inv.checked_in ? '<span class="badge bg-success">Checked In</span>' : '<button id="confirmCheckIn" class="btn btn-success">Confirm Check-In</button>'}
                        </div>
                </div>
            `;

            const confirmBtn = document.getElementById('confirmCheckIn');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', async function() {
                    const r = await postJson('{% url "api_check_in" %}', { barcode_number: inv.barcode_number, check_in: true });
                    renderResult(r, true);
                });
            }
            
            // Auto-clear input after successful check-in (even in single mode)
            if (wasCheckIn && inv.checked_in) {
                setTimeout(() => {
                    document.getElementById('barcode_number').value = '';
                    document.getElementById('barcode_number').focus();
                }, 1500);
            }
        }
    }
</script>
<!-- jsQR library for QR decoding -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
// Camera QR scanning logic
let videoStream = null;
let scanInterval = null;

const startBtn = document.getElementById('startCameraBtn');
const stopBtn = document.getElementById('stopCameraBtn');
const cameraArea = document.getElementById('cameraArea');
const video = document.getElementById('video');
const canvas = document.getElementById('videoCanvas');
const canvasCtx = canvas.getContext('2d');

function extractUUIDFromText(text) {
    // Matches UUID in URL or raw UUID
    const uuidRegex = /([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})/i;
    const m = text.match(uuidRegex);
    return m ? m[1] : null;
}

async function handleDecodedText(text) {
    const uuid = extractUUIDFromText(text);
    if (uuid) {
        // Stop camera to avoid duplicate scans
        stopCamera();
        document.getElementById('barcode_number').value = uuid;
        const result = await postJson('{% url "api_check_in" %}', { unique_code: uuid, check_in: false });
        renderResult(result);
    } else {
        // If no UUID, try to treat decoded text as barcode number
        stopCamera();
        document.getElementById('barcode_number').value = text;
        const result = await postJson('{% url "api_check_in" %}', { barcode_number: text, check_in: false });
        renderResult(result);
    }
}

async function startCamera() {
    try {
        videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
        video.srcObject = videoStream;
        cameraArea.style.display = 'block';
        startBtn.disabled = true;
        stopBtn.disabled = false;

        // Set canvas size to video size when metadata loaded
        video.addEventListener('loadedmetadata', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        });

        // JSQR check (QR codes)
        scanInterval = setInterval(() => {
            if (video.readyState !== video.HAVE_ENOUGH_DATA) return;
            canvasCtx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imgData = canvasCtx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imgData.data, imgData.width, imgData.height, { inversionAttempts: 'attemptBoth' });
            if (code && code.data) {
                handleDecodedText(code.data);
            }
        }, 300);

        // ZXing fallback for 1D barcodes (Code128 etc.)
        try {
            // Load a reader for video streams
            if (window.ZXing && ZXing.BrowserMultiFormatReader) {
                window._zxingReader = new ZXing.BrowserMultiFormatReader();
                window._zxingReader.decodeFromVideoElement(video).then(result => {
                    if (result && result.text) {
                        handleDecodedText(result.text);
                    }
                }).catch(err => {
                    // decodeFromVideoElement returns a promise that resolves on first decode,
                    // subsequent decodes may reject when stopping â€” ignore
                    // console.log('ZXing video decode error', err);
                });
            }
        } catch (e) {
            // ignore if ZXing isn't available
        }
    } catch (e) {
        console.error('Camera start failed', e);
        alert('Unable to access camera: ' + (e.message || e));
    }
}

function stopCamera() {
    if (scanInterval) {
        clearInterval(scanInterval);
        scanInterval = null;
    }
    if (videoStream) {
        videoStream.getTracks().forEach(t => t.stop());
        videoStream = null;
    }
    cameraArea.style.display = 'none';
    startBtn.disabled = false;
    stopBtn.disabled = true;
}

startBtn.addEventListener('click', startCamera);
stopBtn.addEventListener('click', stopCamera);
</script>
<!-- ZXing library for 1D barcode decoding (Code128) -->
<script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>
<script>
// If ZXing is loaded, it will expose a global `ZXing` object.
// The scanning loop already initializes a BrowserMultiFormatReader when available.
</script>
{% endblock %}
